services:
  code-server-with-ai:
    container_name: ${CONTAINER_NAME:-code-server-with-ai}
    image: ${IMAGE_NAME:-code-server-with-ai:latest}
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${HOST_PORT_VSCODE:-8585}:${VSCODE_PORT:-8585}"
      - "${HOST_PORT_OPENCODE:-4096}:${OPENCODE_PORT:-4096}"
      - "${HOST_PORT_OPENCLAW:-18789}:${OPENCLAW_PORT:-18789}"
    environment:
      - VSCODE_HOST=${VSCODE_HOST:-0.0.0.0}
      - VSCODE_PORT=${VSCODE_PORT:-8585}
      - VSCODE_TOKEN=${VSCODE_TOKEN:-}
      - VSCODE_EXTRA_ARGS=${VSCODE_EXTRA_ARGS:-}
      - USE_CDN_PROXY=${USE_CDN_PROXY:-false}
      - CDN_PROXY_HOST=${CDN_PROXY_HOST:-}
      - OPENCODE_HOST=${OPENCODE_HOST:-0.0.0.0}
      - OPENCODE_PORT=${OPENCODE_PORT:-4096}
      - OPENCODE_SERVER_USERNAME=${OPENCODE_SERVER_USERNAME:-opencode}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD:-}
      - OPENCLAW_PORT=${OPENCLAW_PORT:-18789}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - EXTRA_GID=${EXTRA_GID:-}
    volumes:
      - "${DATA_DIR:-./data}:/home/coder"
    init: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
